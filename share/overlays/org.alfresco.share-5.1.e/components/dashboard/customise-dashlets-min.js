(function(){var c=YAHOO.util.Dom,h=YAHOO.util.Event,a=YAHOO.util.Selector;Alfresco.CustomiseDashlets=function(m){Alfresco.CustomiseDashlets.superclass.constructor.call(this,"Alfresco.CustomiseDashlets",m,["button","container","datasource","dragdrop"]);return this};YAHOO.extend(Alfresco.CustomiseDashlets,Alfresco.component.Base,{options:{currentLayout:null,dashboardUrl:null,dashboardId:null},onReady:function d(){this.widgets.addDashletsButton=Alfresco.util.createYUIButton(this,"addDashlets-button",this.onAddDashletsButtonClick);this.widgets.saveButton=Alfresco.util.createYUIButton(this,"save-button",this.onSaveButtonClick,{additionalClass:"alf-primary-button"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this.widgets.dashletListEl=c.get(this.id+"-column-ul-0");this.widgets.trashcanListEl=c.get(this.id+"-trashcan-img");this.widgets.shadowEl=c.get(this.id+"-dashlet-li-shadow");var p={shadow:this.widgets.shadowEl,draggables:[{container:this.widgets.dashletListEl,groups:[Alfresco.util.DragAndDrop.GROUP_MOVE],cssClass:"availableDashlet",protect:true,duplicatesOnEnterKey:true}],targets:[{container:this.widgets.dashletListEl,group:Alfresco.util.DragAndDrop.GROUP_DELETE},{container:this.widgets.trashcanListEl,group:Alfresco.util.DragAndDrop.GROUP_DELETE}]};var n;for(var m=1;true;m++){n=c.get(this.id+"-column-ul-"+m);if(n){p.draggables.push({container:n,groups:[Alfresco.util.DragAndDrop.GROUP_MOVE,Alfresco.util.DragAndDrop.GROUP_DELETE],cssClass:"usedDashlet"});p.targets.push({container:n,group:Alfresco.util.DragAndDrop.GROUP_MOVE,maximum:5})}else{break}}p.keyboardInstruction1=c.get(this.id+"-keyboard-instruction1");p.keyboardInstruction2=c.get(this.id+"-keyboard-instruction2");var o=new Alfresco.util.DragAndDrop(p);YAHOO.Bubbling.on("onDashboardLayoutChanged",this.onDashboardLayoutChanged,this);YAHOO.Bubbling.on("onDashboardLayoutsDisplayed",this.onDashboardLayoutsDisplayed,this);YAHOO.Bubbling.on("onDashboardLayoutsHidden",this.onDashboardLayoutsHidden,this);h.addListener(this.id+"-closeAddDashlets-link","click",this.onCloseAddDashletsLinkClick,this,true);this.widgets.availableDiv=c.get(this.id+"-available-div");this.widgets.toggleDashletsButtonWrapperDiv=c.get(this.id+"-toggleDashletsButtonWrapper-div")},onDashboardLayoutChanged:function l(p,m){var q=m[1].dashboardLayout;this.options.currentLayout=q;var r=c.get(this.id+"-wrapper-div");if(q){for(var o=1;true;o++){var n=c.get(this.id+"-column-div-"+o);if(n){if(o<=q.noOfColumns){c.setStyle(n,"display","")}else{c.setStyle(n,"display","none")}c.removeClass(r,"noOfColumns"+o)}else{break}}c.addClass(r,"noOfColumns"+q.noOfColumns)}else{throw new Error("The argument for event 'onDashboardLayoutChanged' has changed.")}},onDashboardLayoutsDisplayed:function e(n,m){c.setStyle(this.id,"display","none")},onDashboardLayoutsHidden:function g(n,m){c.setStyle(this.id,"display","")},onAddDashletsButtonClick:function f(m){c.setStyle(this.widgets.toggleDashletsButtonWrapperDiv,"display","none");Alfresco.util.Anim.fadeIn(this.widgets.availableDiv)},onCloseAddDashletsLinkClick:function b(m){c.setStyle(this.widgets.toggleDashletsButtonWrapperDiv,"display","");c.setStyle(this.widgets.availableDiv,"display","none");h.stopEvent(m)},onSaveButtonClick:function j(n){this.widgets.saveButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);var r=[];for(var t=1;t<=this.options.currentLayout.noOfColumns;t++){var u=c.get(this.id+"-column-ul-"+t);var w=c.getElementsByClassName("usedDashlet","li",u);for(var s=0;s<w.length;s++){var v=w[s];if(!c.hasClass(v,"dnd-shadow")){var o={url:a.query("input[type=hidden][name=dashleturl]",v,true).value,regionId:"component-"+t+"-"+(s+1)};var q=a.query("input[type=hidden][name=originalregionid]",v,true);if(q){o.originalRegionId=q.value}r[r.length]=o}}}var p=this.options.currentLayout.templateId;var m={dashboardPage:this.options.dashboardId,templateId:p,dashlets:r};Alfresco.util.Ajax.jsonRequest({method:Alfresco.util.Ajax.POST,url:Alfresco.constants.URL_SERVICECONTEXT+"components/dashboard/customise-dashboard",dataObj:m,successCallback:{fn:this.saveWelcomePanelPreference,scope:this},failureMessage:Alfresco.util.message("message.saveFailure",this.name),failureCallback:{fn:function(){this.widgets.feedbackMessage.destroy();this.widgets.saveButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false)},scope:this}});this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.saving",this.name),spanClass:"wait",displayTime:0})},onCancelButtonClick:function i(m){this.widgets.saveButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);document.location.href=Alfresco.constants.URL_PAGECONTEXT+""+this.options.dashboardUrl},saveWelcomePanelPreference:function k(){var m=c.get(this.id+"-welcomePanelEnabled");if(m&&this.options.welcomePanelEnabled!=m.checked){Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.URL_SERVICECONTEXT+"components/dashboard/welcome-preference",dataObj:{welcomePanelEnabled:m.checked},successCallback:{fn:function(){document.location.href=Alfresco.constants.URL_PAGECONTEXT+""+this.options.dashboardUrl},scope:this},failureMessage:this.msg("message.saveFailure")})}else{document.location.href=Alfresco.constants.URL_PAGECONTEXT+""+this.options.dashboardUrl}}})})();new Alfresco.CustomiseDashlets(null);