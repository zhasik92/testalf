(function(){var h=YAHOO.util.Dom,p=YAHOO.util.Event;var f=Alfresco.util.encodeHTML,b=function b(r,s){return Alfresco.util.formatDate(Alfresco.util.fromISO8601(r),s)};Alfresco.ConsoleHybridSyncManagement=function l(r){Alfresco.ConsoleHybridSyncManagement.superclass.constructor.call(this,"Alfresco.ConsoleHybridSyncManagement",r,["button","container","datasource","datatable","paginator","history","animation"]);return this};YAHOO.extend(Alfresco.ConsoleHybridSyncManagement,Alfresco.component.Base,{options:{pageSize:15,username:""},ssdId:"",ssdSyncCreator:"",ssdFailed:null,ssdFailedReason:null,resultsCount:0,currentPage:1,sortDir:"asc",sortField:"syncCreator",onReady:function n(){this._setupDataTable();this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);this.widgets.exportCSVButton=Alfresco.util.createYUIButton(this,"browse-button",this.onExportCSV);var s=h.get(this.id+"-ssd-id");this.widgets.enterListener=new YAHOO.util.KeyListener(s,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:this.onSearchClick,scope:this,correctScope:true},"keydown").enable();s.value=this.ssdId;var r=h.get(this.id+"-ssd-sync-creator");this.widgets.enterListener=new YAHOO.util.KeyListener(r,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:this.onSearchClick,scope:this,correctScope:true},"keydown").enable();r.value=this.ssdSyncCreator;this._reloadSearchData()},_setDefaultDataTableErrors:function q(r){r.set("MSG_EMPTY",this.msg("message.no-ssds"))},_setupDataTable:function k(){var J=this;var r=function s(O,N,Q,S){var R=N.getData().entry.id;var P="<span>"+f(R)+"</span>";O.innerHTML=P};var B=function F(P,O,R,S){var N=O.getData().entry.syncError;var Q="<span>"+f(N)+"</span>";P.innerHTML=Q};var E=function u(P,O,S,T){var R=O.getData().entry.path;var N=O.getData().entry.nodeRef;var Q='<span><a class="theme-color-1" href="'+Alfresco.constants.URL_PAGECONTEXT+"console/admin-console/node-browser#state=panel%3Dview%26nodeRef%3D"+encodeURIComponent(N)+'">'+f(R)+"</a></span>";P.innerHTML=Q};var A=function C(O,N,R,S){var Q=N.getData().entry.syncCreator;var P;if(N.getData().entry.syncCreatorExists=="true"){P=Alfresco.util.userProfileLink(Q,"",'class="theme-color-1"')}else{P='<span title="'+J.msg("message.ssd-sync-creator-no-link")+'">'+f(Q)+"</span>"}O.innerHTML=P};var z=function K(P,O,R,S){var N=O.getData().entry.cloudUsername;var Q="<span>"+f(N)+"</span>";P.innerHTML=Q};var v=function H(P,N,R,S){var O=N.getData().entry.remoteTenantId;var Q="<span>"+f(O)+"</span>";P.innerHTML=Q};var M=function D(P,O,R,S){var N=O.getData().entry.targetFolderNodeRef;var Q="<span>"+f(N)+"</span>";P.innerHTML=Q};var x=function w(Q,P,R,U){var T=P.getData();if(J.options.username!==T.entry.syncCreator){var S="",O,N=P._nCount;h.addClass(Q,"align-center");S+='<a id="'+J.id+"-reassign-link-"+N+'" href="#" class="reassign-ssd" title="'+J.msg("button.ssd-reassign.label")+'">&nbsp;</a>';Q.innerHTML=S;O=h.getChildrenBy(Q,function(V){return V.id===J.id+"-reassign-link-"+N})[0];p.addListener(P.getId(),"mouseover",function(){h.addClass(O,"reassign-ssd-active")});p.addListener(P.getId(),"mouseout",function(){h.removeClass(O,"reassign-ssd-active")});p.addListener(O,"click",function(){J.onReassignHybridSync(T.entry.id,T.entry.remoteTenantId)},O,false)}};var y=Alfresco.constants.PROXY_URI+"enterprise/sync/syncsetdefinitionsadmin?";this.widgets.dataSource=new YAHOO.util.DataSource(y);this.widgets.dataSource.responseType=YAHOO.util.DataSource.TYPE_JSON;this.widgets.dataSource.connXhrMode="queueRequests";this.widgets.dataSource.responseSchema={resultsList:"list.entries",fields:["entry"],metaFields:{totalRecords:"list.pagination.totalItems",count:"list.pagination.count"}};this.widgets.paginator=new YAHOO.widget.Paginator({containers:this.id+"-paginator",rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});var G=[{key:"id",label:J.msg("hybridsync.ssd-id-header-label"),sortable:true,formatter:r},{key:"syncError",label:J.msg("hybridsync.ssd-failed-reason-header-label"),sortable:true,formatter:B},{key:"path",label:J.msg("hybridsync.path-desc-header-label"),sortable:false,formatter:E},{key:"syncCreator",label:J.msg("hybridsync.sync-creator-header-label"),sortable:true,formatter:A},{key:"cloudUsername",label:J.msg("hybridsync.cloud-user-header-label"),sortable:false,formatter:z},{key:"remoteTenantId",label:J.msg("hybridsync.remote-tenant-id-header-label"),sortable:true,formatter:v},{key:"targetFolderNodeRef",label:J.msg("hybridsync.target-folder-node-ref-header-label"),sortable:false,formatter:M},{key:"action",label:J.msg("hybridsync.actions-header-label"),sortable:false,formatter:x,width:45}];var t=function(Q,S){Q=Q||{pagination:null,sortedBy:null};var R=(Q.sortedBy)?Q.sortedBy.key:"syncCreator";var P=(Q.sortedBy&&Q.sortedBy.dir===YAHOO.widget.DataTable.CLASS_DESC)?"desc":"asc";J.sortDir=P;J.sortField=R;var N=(Q.pagination)?Q.pagination.recordOffset:0;var T=(Q.pagination)?Q.pagination.rowsPerPage:15;var O="dir="+J.sortDir+"&sort="+J.sortField+"&skipCount="+N+"&maxItems="+T;O=J.addQueryParam(O,"ssdId",J.ssdId);O=J.addQueryParam(O,"ssdSyncCreator",J.ssdSyncCreator);O=J.addQueryParam(O,"ssdFailed",J.ssdFailed);O=J.addQueryParam(O,"ssdFailedReason",J.ssdFailedReason);return O};this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-ssds",G,this.widgets.dataSource,{generateRequest:t,renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,paginator:this.widgets.paginator,MSG_LOADING:this.msg("message.ssds-loading.data.message"),MSG_EMPTY:this.msg("message.no-ssds"),dynamicData:true,sortedBy:{key:"syncCreator",dir:YAHOO.widget.DataTable.CLASS_ASC}});this.widgets.dataTable.doBeforeLoadData=function L(O,P,R){if(P.error){try{var N=YAHOO.lang.JSON.parse(P.responseText);J.widgets.dataTable.set("MSG_ERROR",N.message)}catch(Q){J._setDefaultDataTableErrors(J.widgets.dataTable);J.widgets.dataTable.render()}}else{if(P.results){J.widgets.dataTable.set("MSG_EMPTY","");J.hasMoreResults=(P.results.length>J.options.maxSearchResults);if(J.hasMoreResults){P.results=P.results.slice(0,J.options.maxSearchResults)}J.resultsCount=P.results.length;if(J.resultsCount>0){h.removeClass(J.id+"-paginator","hidden");h.removeClass(J.id+"-ssds-list-bar-bottom","hidden");h.removeClass(J.id+"-ssds","hidden");h.addClass(J.id+"-ssds-list-info","hidden")}else{h.addClass(J.id+"-paginator","hidden");h.addClass(J.id+"-ssds-list-bar-bottom","hidden");h.addClass(J.id+"-ssds","hidden");h.get(J.id+"-ssds-list-info").innerHTML=J.msg("message.no-ssds");h.removeClass(J.id+"-ssds-list-info","hidden")}}}return true};this.widgets.dataTable.handleDataReturnPayload=function I(O,N,P){P=P||{};P.totalRecords=N.meta.totalRecords;J.resultsCount=totalRecords=N.meta.totalRecords;J.currentPage=P.page;J.widgets.paginator.setState(P);return P};this.widgets.dataTable.subscribe("renderEvent",function(){J.widgets.paginator.setState({page:J.currentPage,totalRecords:J.resultsCount});J.widgets.paginator.render()})},onSearchClick:function j(u,r){var v=h.get(this.id+"-ssd-id");var t=h.get(this.id+"-ssd-sync-creator");var w=h.get(this.id+"-ssd-failed");var s=h.get(this.id+"-ssd-failed-reason");this._performSearch({ssdId:v.value,ssdSyncCreator:t.value,ssdFailed:w.checked,ssdFailedReason:s.value})},onRequestFailure:function a(s,t){if(t.status==401){window.location.reload()}else{try{var r=YAHOO.lang.JSON.parse(t.responseText);this.widgets.dataTable.set("MSG_ERROR",r.message);this.widgets.dataTable.showTableMessage(r.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(u){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.render()}}},_performSearch:function m(t){if(t.ssdId!=undefined){this.ssdId=YAHOO.lang.trim(t.ssdId)}if(t.ssdSyncCreator!=undefined){this.ssdSyncCreator=YAHOO.lang.trim(t.ssdSyncCreator)}if(t.ssdFailed!=undefined&&t.ssdFailed){this.ssdFailed=true}else{this.ssdFailed=false}if(t.ssdFailedReason!=undefined){this.ssdFailedReason=YAHOO.lang.trim(t.ssdFailedReason)}this.widgets.dataTable.set("MSG_EMPTY","");this.widgets.dataTable.render();this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());var u=this.widgets.dataTable.getState();u.sortedBy={key:"syncCreator",dir:YAHOO.widget.DataTable.CLASS_ASC};function s(v,w,x){this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,v,w,x);this.resultsCount=w.meta.totalRecords;this.currentPage=1;h.get(this.id+"-ssd-id").focus()}var r="dir=asc&sort=syncCreator&skipCount=0&maxItems="+this.options.pageSize;r=this.addQueryParam(r,"ssdId",this.ssdId);r=this.addQueryParam(r,"ssdSyncCreator",this.ssdSyncCreator);r=this.addQueryParam(r,"ssdFailed",this.ssdFailed);r=this.addQueryParam(r,"ssdFailedReason",this.ssdFailedReason);this.widgets.dataSource.sendRequest(r,{success:s,failure:this.onRequestFailure,scope:this})},_reloadSearchData:function d(){this._performSearch({ssdId:this.ssdId,ssdSyncCreator:this.ssdSyncCreator,ssdFailed:this.ssdFailed,ssdFailedReason:this.ssdFailedReason})},addQueryParam:function g(r,t,s){if(r!==null&&t!==null&&s!==null&&typeof(s)!=="undefined"){r=r+"&"+t+"="+encodeURIComponent(s)}return r},_appendSearchParams:function e(r){var u=h.get(this.id+"-ssd-id");var t=h.get(this.id+"-ssd-sync-creator");var v=h.get(this.id+"-ssd-failed");var s=h.get(this.id+"-ssd-failed-reason");r=this.addQueryParam(r,"ssdId",u.value);r=this.addQueryParam(r,"ssdSyncCreator",t.value);r=this.addQueryParam(r,"ssdFailed",v.checked);r=this.addQueryParam(r,"ssdFailedReason",s.value);return r},onReassignHybridSync:function i(t,r){var v=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.ssd-reassign",t),text:this.msg("message.ssd-reassign-prompt",t),buttons:[{text:this.msg("button.ssd-reassign.confirm-label"),handler:function u(){this.destroy();v._onReassignHybridSyncConfirm(t,r)}},{text:this.msg("button.ssd-reassign.cancel-label"),handler:function s(){this.destroy()},isDefault:true}]})},_onReassignHybridSyncConfirm:function c(s,r){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.POST,url:Alfresco.constants.PROXY_URI+"enterprise/sync/syncsetdefreassignment",requestContentType:"application/json",responseContentType:"application/json",dataObj:{ssdId:s,remoteTenantId:r},successCallback:{fn:function t(u){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.ssd-reassign.success")});this._reloadSearchData()},scope:this},failureMessage:this.msg("message.ssd-reassign.failure")})},onExportCSV:function o(){var u=h.get(this.id+"-ssd-id");var t=h.get(this.id+"-ssd-sync-creator");var v=h.get(this.id+"-ssd-failed");var s=h.get(this.id+"-ssd-failed-reason");var r=Alfresco.constants.PROXY_URI+"enterprise/sync/syncsetdefinitionsadmin?format=csv&dir=asc&sort=syncCreator";r=this.addQueryParam(r,"ssdId",u.value);r=this.addQueryParam(r,"ssdSyncCreator",t.value);r=this.addQueryParam(r,"ssdFailed",v.checked);r=this.addQueryParam(r,"ssdFailedReason",s.value);window.open(r)}})})();