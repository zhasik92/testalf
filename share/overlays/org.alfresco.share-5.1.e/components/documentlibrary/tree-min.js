(function(){var a=YAHOO.util.Dom,y=YAHOO.util.Event;var i=Alfresco.util.combinePaths;Alfresco.DocListTree=function p(z){Alfresco.DocListTree.superclass.constructor.call(this,"Alfresco.DocListTree",z,["treeview","json"]);this.filterId="path";Alfresco.util.FilterManager.register(this.name,this.filterId);this.currentFilter={};this.pathsToExpand=[];YAHOO.Bubbling.on("folderCopied",this.onFolderCopied,this);YAHOO.Bubbling.on("folderCreated",this.onFolderCreated,this);YAHOO.Bubbling.on("folderDeleted",this.onFolderDeleted,this);YAHOO.Bubbling.on("folderMoved",this.onFolderMoved,this);YAHOO.Bubbling.on("folderRenamed",this.onFolderRenamed,this);YAHOO.Bubbling.on("filterChanged",this.onFilterChanged,this);YAHOO.Bubbling.on("dropTargetOwnerRequest",this.onDropTargetOwnerRequest,this);YAHOO.Bubbling.on("documentDragOver",this.onDocumentDragOver,this);YAHOO.Bubbling.on("documentDragOut",this.onDocumentDragOut,this);return this};YAHOO.extend(Alfresco.DocListTree,Alfresco.component.Base,{options:{siteId:"",containerId:"documentLibrary",evaluateChildFolders:true,maximumFolderCount:-1,setDropTargets:false,customFolderStyleConfig:null},isReady:false,initialFilter:null,currentPath:"",currentFilter:null,isFilterOwner:false,pathsToExpand:null,selectedNode:null,onReady:function x(){var z=this;Alfresco.util.createTwister(this.id+"-h2",this.name.substring(this.name.lastIndexOf(".")+1));this.fnLoadNodeData=function A(F,C){var D=F.data.path;var E=z._buildTreeNodeUrl.call(z,D);var H={success:function B(L){var K=YAHOO.lang.JSON.parse(L.responseText),M,N;if(K.parent&&F.data.nodeRef.length===0){F.data.nodeRef=K.parent.nodeRef}if(K.items){for(var J=0,I=K.items.length;J<I;J++){M=K.items[J];M.path=i(D,M.name);N=this._buildTreeNode(M,F,false);if(!M.hasChildren){N.isLeaf=true}}}if(K.resultsTrimmed){tempNode=new YAHOO.widget.TextNode({label:"<"+this.msg("message.folders-trimmed",K.items.length)+">",hasIcon:false,style:"folders-trimmed"},F,false)}L.argument.fnLoadComplete();YAHOO.Bubbling.fire("docLibTreeLoadComplete")},failure:function G(L){if(L.status==401){window.location.reload()}else{try{var K=YAHOO.lang.JSON.parse(L.responseText);var J=this.widgets.treeview.getRoot();var I=J.children[0];I.isLoading=false;I.isLeaf=true;if(L.status==403){I.label=this.msg("message.refresh.failure.forbidden")}else{I.label=K.message;I.labelStyle="ygtverror"}J.refresh()}catch(M){}}},scope:z,argument:{node:F,fnLoadComplete:C}};YAHOO.util.Connect.asyncRequest("GET",E,H)};this._buildTree();this.isReady=true;if(this.initialFilter!==null){this.onFilterChanged("filterChanged",[null,this.initialFilter])}},onDropTargetOwnerRequest:function t(A,z){if(z&&z[1]&&z[1].elementId){var C=this.widgets.treeview.getNodeByElement(a.get(z[1].elementId));if(C!=null){this.onDocumentDragOut(A,z);var B=C.data.nodeRef;var D=C.data.path;z[1].callback.call(z[1].scope,B,D)}}},onDocumentDragOver:function j(C,B){if(B&&B[1]&&B[1].elementId){var G=this.widgets.treeview.getEl();if(B[1].event.clientX>G.clientWidth){}else{var A=a.get(B[1].elementId);if(A!=this.widgets.treeview.getEl()){var F=this.widgets.treeview.getNodeByElement(A);if(F!=null){var z=A;while(z.tagName!="TABLE"){z=z.parentNode}a.addClass(z,"documentDragOverHighlight");var E=A.children[A.children.length-2];while(E.children.length==1){var D=document.createElement("span");a.addClass(D,"documentDragOverArrow");E.appendChild(D)}}}}}},onDocumentDragOut:function e(D,H){if(H&&H[1]&&H[1].elementId){var G=a.get(H[1].elementId);if(G==this.widgets.treeview.getEl()){var F=a.getElementsByClassName("documentDragOverHighlight","table",G);for(var C=0,B=F.length;C<B;C++){a.removeClass(F[C],"documentDragOverHighlight")}var I=a.getElementsByClassName("documentDragOverArrow","span",G);for(var C=0,B=I.length;C<B;C++){I[C].parentNode.removeChild(I[C])}}else{var A=this.widgets.treeview.getNodeByElement(G);if(A!=null){var E=G;while(E.tagName!="TABLE"){E=E.parentNode}a.removeClass(E,"documentDragOverHighlight");var z=G.children[G.children.length-2];while(z.children.length>1){z.removeChild(a.getLastChild(z))}}}}},onExpandComplete:function d(A){this.widgets.treeview.render();if(this.isFilterOwner){this._showHighlight(true)}if(this.pathsToExpand&&this.pathsToExpand.length>0){var z=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(z!==null){if(z.data.path==this.currentPath){this._updateSelectedNode(z)}Alfresco.logger.debug("node.expand: DLT_onExpandComplete");z.expand()}}else{if(this.initialFilter!==null){this.onFilterChanged("filterChanged",[null,{filterId:this.initialFilter.filterId,filterOwner:this.initialFilter.filterOwner,filterData:this.initialFilter.filterData}]);this.initialFilter=null}else{this._applyDropTargets()}}},_applyDropTargets:function g(){if(this.options.setDropTargets){var C=this.widgets.treeview.getEl();new YAHOO.util.DDTarget(C);a.addClass(C,"documentDroppableHighlights");var z=a.getElementsByClassName("ygtvrow","tr",C);for(var B=0,A=z.length;B<A;B++){new YAHOO.util.DDTarget(z[B]);a.addClass(z[B],"documentDroppable");a.addClass(z[B],"documentDroppableHighlights")}}},onNodeClicked:function v(z){var A=z.node;if(this.isFilterOwner&&A==this.selectedNode){YAHOO.Bubbling.fire("metadataRefresh")}else{this._updateSelectedNode(A);YAHOO.Bubbling.fire("changeFilter",{filterOwner:this.name,filterId:this.filterId,filterData:A.data.path})}y.stopEvent(z.event);return false},pathChanged:function m(D,z){D=i("/",D);this.currentPath=D;var C=this.widgets.treeview.getNodeByProperty("path",D);if(C!==null){this._updateSelectedNode(C);if(!C.expanded){Alfresco.logger.debug("node.expand: DLT_pathChanged",D);C.expand()}while(C.parent!==null){C=C.parent;if(!C.expanded){Alfresco.logger.debug("node.expand: DLT_onPathChanged (parent)",D);C.expand()}}return}var E=D.split("/"),B="/";if(D==="/"){E=[""]}for(var A=0;A<E.length;A++){B=i(B,E[A]);this.pathsToExpand.push(B)}do{C=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift())}while(this.pathsToExpand.length>0&&C&&C.expanded);if(C!==null){Alfresco.logger.debug("node.expand: DLT_onPathChanged (pathsToExpand)",this.pathsToExpand);C.expand()}},onFolderRenamed:function q(C,A){var E=A[1];if(E&&(E.file!==null)){var D=this.widgets.treeview.getNodeByProperty("nodeRef",E.file.node.nodeRef);if(D!==null){var z=-1;var B=function(G){var H=G.data.path.split("/");if(z<0){H.pop();z=H.length;G.data.path=i(H.join("/"),E.file.location.file)}else{H[z]=E.file.displayName;G.data.path=H.join("/")}if(G.hasChildren){for(var F=0;F<G.children.length;F++){B(G.children[F])}}};B(D);D.label=E.file.displayName;this.widgets.treeview.render();this._showHighlight(true)}}this._applyDropTargets()},onFolderCopied:function k(A,z){var B=z[1];if(B!==null){if(B.nodeRef&&B.destination){var C=this.widgets.treeview.getNodeByProperty("path",i("/",B.destination));if(C){if(C.expanded){this._sortNodeChildren(C)}else{C.isLeaf=false}}this.widgets.treeview.render();this._showHighlight(true)}}this._applyDropTargets()},onFolderCreated:function n(B,A){var C=A[1];if(C&&(C.parentNodeRef!==null)){var z=this.widgets.treeview.getNodeByProperty("nodeRef",C.parentNodeRef);if(z!==null){if(!z.hasChildren()&&z.isLeaf===true){z.dynamicLoadComplete=false}this._sortNodeChildren(z)}}},onFolderDeleted:function u(B,A){var D=A[1];if(D!==null){var C=null;if(D.path){C=this.widgets.treeview.getNodeByProperty("path",i("/",D.path))}else{if(D.nodeRef){C=this.widgets.treeview.getNodeByProperty("nodeRef",D.nodeRef)}}if(C!==null){var z=C.parent;this.widgets.treeview.removeNode(C);if(z!==null){if(!z.hasChildren()){z.isLeaf=true}}this.widgets.treeview.render();this._showHighlight(true)}}this._applyDropTargets()},onFolderMoved:function w(B,A){var D=A[1];if(D!==null){if(typeof D.nodeRef!=="undefined"&&typeof D.destination!=="undefined"){var C=null;C=this.widgets.treeview.getNodeByProperty("nodeRef",D.nodeRef);if(C!==null){var z=C.parent;this.widgets.treeview.removeNode(C,true);if(z!==null){if(!z.hasChildren()){z.isLeaf=true}}var E=this.widgets.treeview.getNodeByProperty("path",i("/",D.destination));if(E){if(!E.isLoading){if(E.isLeaf){E.isLeaf=false}else{if(E.expanded){this._sortNodeChildren(E)}}this.widgets.treeview.render();this._showHighlight(true)}}}}}this._applyDropTargets()},onFilterChanged:function c(A,z){var B=z[1];if((B!==null)&&(B.filterId!==null)){B.filterOwner=B.filterOwner||Alfresco.util.FilterManager.getOwner(B.filterId);if(!this.isReady){this.initialFilter=Alfresco.util.cleanBubblingObject(B);Alfresco.logger.debug("DLT_onFilterChanged (deferring)",this.initialFilter);return}Alfresco.logger.debug("DLT_onFilterChanged",B);this.initialFilter=null;this.currentFilter=Alfresco.util.cleanBubblingObject(B);this.isFilterOwner=(B.filterOwner==this.name);if(this.isFilterOwner){this.pathChanged(this.currentFilter.filterData,B)}this._showHighlight(this.isFilterOwner)}},_buildTree:function f(){var z=new YAHOO.widget.TreeView(this.id+"-treeview");this.widgets.treeview=z;YAHOO.widget.TreeView.FOCUS_CLASS_NAME="";z.setDynamicLoad(this.fnLoadNodeData);var A=z.getRoot();this._buildTreeNode({name:Alfresco.util.message("node.root",this.name),path:"/",nodeRef:""},A,false);z.subscribe("clickEvent",this.onNodeClicked,this,true);z.subscribe("expandComplete",this.onExpandComplete,this,true);z.render()},_sortNodeChildren:function s(C,D){if(C.isLeaf){C.isLeaf=false;this.widgets.treeview.render();this._showHighlight(true);return}var A=C.data.path;var B=this._buildTreeNodeUrl(A);var F={success:function z(J){var N=YAHOO.lang.JSON.parse(J.responseText);if(N.items){var G=J.argument.node.children;var Q=N.items;for(var O=0,M=Q.length;O<M;O++){if((G.length<=O)||(G[O].data.nodeRef!=Q[O].nodeRef)){var H=false;for(var K=O,I=G.length;K<I;K++){if(G[K].data.nodeRef==Q[O].nodeRef){var S=G[O];G[O]=G[K];G[K]=S;H=true;break}}if(!H){var T=Q[O];T.path=i(J.argument.node.data.path,T.name);var L=this._buildTreeNode(T);if(!T.hasChildren){L.isLeaf=true}if(G.length===0){var P=J.argument.node;P.isLeaf=false;L.appendTo(P)}else{if(G.length>O){L.insertBefore(G[O])}else{L.insertAfter(G[G.length-1])}}}}}this.widgets.treeview.render();this._showHighlight(true);var R=J.argument.onSortComplete;if(R&&typeof R.fn=="function"){R.fn.call(R.scope?R.scope:this,R.obj)}this._applyDropTargets()}},failure:function E(G){Alfresco.logger.error("DLT_sNC_failure",G)},argument:{node:C,onSortComplete:D},scope:this,timeout:7000};YAHOO.util.Connect.asyncRequest("GET",B,F)},_showHighlight:function o(z){if(this.selectedNode!==null){if(z){a.addClass(this.selectedNode.getEl(),"selected")}else{a.removeClass(this.selectedNode.getEl(),"selected")}}},_updateSelectedNode:function l(z){if(this.isFilterOwner){this._showHighlight(false);this.selectedNode=z;this._showHighlight(true)}else{this.selectedNode=z}},_buildTreeNode:function b(z,B,A){var C=new YAHOO.widget.TextNode({label:z.name,path:z.path,nodeRef:z.nodeRef,description:z.description},B,A);var D=this._buildCustomStyleClass(z);C.customCls=D;return C},_buildCustomStyleClass:function r(z){var B=null;if(this.options.customFolderStyleConfig){var A=new Alfresco.CommonComponentStyleFilterChain(z,this.options.customFolderStyleConfig.browse.folder);B=A.createCustomStyle()}return B},_buildTreeNodeUrl:function h(z){var A="slingshot/doclib/treenode/site/"+i(encodeURIComponent(this.options.siteId),encodeURIComponent(this.options.containerId),Alfresco.util.encodeURIPath(z));A+="?perms=false&children="+this.options.evaluateChildFolders+"&max="+this.options.maximumFolderCount;return Alfresco.constants.PROXY_URI+A}})})();