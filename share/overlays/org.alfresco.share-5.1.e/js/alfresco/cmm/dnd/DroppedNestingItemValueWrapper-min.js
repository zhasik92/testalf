define(["dojo/_base/declare","cmm/dnd/DroppedItemValueWrapper","alfresco/dnd/Constants","alfresco/core/ObjectTypeUtils","dojo/_base/lang","dojo/_base/array","dojo/on","dojo/Deferred","dijit/registry","jquery"],function(p,i,c,j,r,e,h,a,f,d){return p([i],{postCreate:function n(){var s=new a();s.then(r.hitch(this,this.onNestedConfig));this.alfPublish(c.requestWidgetsForNestedConfigTopic,{value:this.value,promise:s});this.inherited(arguments);h(this.domNode,c.updateItemsEvent,r.hitch(this,this.onNestedTargetUpdated));h(this.domNode,c.reorderItemsEvent,r.hitch(this,this.onNestedTargetReordered))},allWidgetsProcessed:function o(s){this.inherited(arguments);e.forEach(s,function(u){u.widgetsForNestedConfig=this._widgetsForNestedConfig;if(u.targetProperty){var t=r.getObject(u.targetProperty,false,this.value);if(t&&typeof u.setValue==="function"){u.setValue(t)}}},this)},onItemDelete:function g(s){var t=d(this.domNode).index();e.forEach(this._renderedWidgets,function(v){if(v.previewTarget&&typeof v.previewTarget.getAllNodes==="function"){var u=v.previewTarget.getAllNodes.call(v.previewTarget);e.forEach(u,function(y){var x=f.byNode(y);if(x&&typeof x.onItemDelete==="function"){x.onItemDelete.call(x)}})}});h.emit(this.domNode,c.deleteItemEvent,{bubbles:true,cancelable:true,targetWidget:this,deleteIndex:t});this.alfPublish(c.itemDeletedTopic,{item:this.getValue()})},onNestedTargetUpdated:function b(s){if(s.targetWidget===this){}else{if(typeof s.stopPropagation==="function"){s.stopPropagation()}if(typeof s.preventDefault==="function"){s.preventDefault()}if(s.targetWidget){if(s.targetWidget.targetProperty&&typeof s.targetWidget.getValue==="function"){var u=r.getObject(s.targetWidget.targetProperty,false,this.value);if(!j.isArray(u)){r.setObject(s.targetWidget.targetProperty,s.targetWidget.getValue(),this.value);this.notifyParentOfChange()}else{if(!isNaN(s.index)){u[s.index]=s.targetWidget.getValue();this.notifyParentOfChange()}else{if(!isNaN(s.deleteIndex)){u.splice(s.deleteIndex,1);this.notifyParentOfChange()}else{var t=[];e.forEach(s.targetWidget.previewTarget.getAllNodes(),function(v){var w=f.getEnclosingWidget(v);if(w&&typeof w.getValue==="function"){t.push(w.getValue())}},this);r.setObject(s.targetWidget.targetProperty,t,this.value);this.notifyParentOfChange()}}}}else{this.alfLog("warn","The 'targetWidget' has no 'targetProperty' or no 'getValue' function",s.targetWidget,this)}}else{this.alfLog("warn","The update event contains no 'targetWidget' attribute",s,this)}}},onNestedTargetReordered:function q(s){if(s.targetWidget===this){}else{if(typeof s.stopPropagation==="function"){s.stopPropagation()}if(typeof s.preventDefault==="function"){s.preventDefault()}if(s.targetWidget&&s.targetWidget.targetProperty){var v=r.getObject(s.targetWidget.targetProperty,false,this.value);if(!j.isArray(v)){this.alfLog("warn","Can't reorder because the targetProperty does not exist or is not an array",s.targetWidget.targetProperty,this.value,this)}else{if(isNaN(s.oldIndex)||isNaN(s.newIndex)){this.alfLog("warn","Can't reorder because either the oldIndex or the newIndex (or both) are missing or are not numbers",s,this)}else{var u=v[s.oldIndex];var t=v[s.newIndex];v[s.oldIndex]=t;v[s.newIndex]=u;this.notifyParentOfChange()}}}else{this.alfLog("warn","The update event contains no 'targetWidget' attribute",s,this)}}},notifyParentOfChange:function k(){h.emit(this.domNode,c.updateItemsEvent,{bubbles:true,cancelable:true,targetWidget:this,index:d(this.domNode).index()})},onNestedConfig:function m(s){if(s.widgets){this._widgetsForNestedConfig=s.widgets}else{this.alfLog("warn","Wigets were not provided in the resolved promise",s,this)}},onEditConfig:function l(s,t){if(t.widgets&&this.widgetsForNestedConfig){t.widgets=this.widgetsForNestedConfig.concat(t.widgets)}this.inherited(arguments)}})});