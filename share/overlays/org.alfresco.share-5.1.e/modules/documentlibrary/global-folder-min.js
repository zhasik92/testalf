(function(){var b=YAHOO.util.Dom,E=YAHOO.util.Event,s=YAHOO.util.KeyListener,x=YAHOO.util.Selector;var u=Alfresco.util.encodeHTML,r=Alfresco.util.combinePaths,B=Alfresco.util.hasEventInterest;Alfresco.module.DoclibGlobalFolder=function(F){Alfresco.module.DoclibGlobalFolder.superclass.constructor.call(this,"Alfresco.module.DoclibGlobalFolder",F,["button","container","connection","json","treeview"]);this.containers={};if(F!="null"){this.eventGroup=F;try{YAHOO.Bubbling.unsubscribe("siteChanged",null,this);YAHOO.Bubbling.unsubscribe("containerChanged",null,this)}catch(G){}YAHOO.Bubbling.on("siteChanged",this.onSiteChanged,this);YAHOO.Bubbling.on("containerChanged",this.onContainerChanged,this)}return this};var z=Alfresco.module.DoclibGlobalFolder;YAHOO.lang.augmentObject(z,{VIEW_MODE_SITE:0,VIEW_MODE_REPOSITORY:1,VIEW_MODE_USERHOME:2,VIEW_MODE_RECENT_SITES:3,VIEW_MODE_FAVOURITE_SITES:4,VIEW_MODE_SHARED:5});YAHOO.extend(Alfresco.module.DoclibGlobalFolder,Alfresco.component.Base,{options:{siteId:"",siteTitle:"",containerId:"documentLibrary",containerType:"cm:folder",rootNode:"alfresco://company/home",sharedRoot:"alfresco://company/shared",userHome:"alfresco://user/home",path:"",pathNodeRef:null,width:"60em",files:null,templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/global-folder",viewMode:z.VIEW_MODE_RECENT_SITES,defaultView:z.VIEW_MODE_RECENT_SITES,allowedViewModes:[z.VIEW_MODE_SITE,z.VIEW_MODE_RECENT_SITES,z.VIEW_MODE_FAVOURITE_SITES,z.VIEW_MODE_SHARED,z.VIEW_MODE_REPOSITORY,z.VIEW_MODE_USERHOME],evaluateChildFoldersSite:true,maximumFolderCountSite:-1,webscriptTimeout:7000,evaluateChildFoldersRepo:true,maximumFolderCountRepo:-1,siteTreeContainerTypes:{},sitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites",recentSitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites/recent",favouriteSitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites/favourites",containersAPI:Alfresco.constants.PROXY_URI+"slingshot/doclib/containers/",templateFailMessage:"Could not load 'global-folder' template",customFolderStyleConfig:null},containerDiv:null,pathsToExpand:null,selectedNode:null,containers:null,showDialog:function m(){if(!this.containerDiv){Alfresco.util.Ajax.request({url:this.options.templateUrl,dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:this.options.templateFailMessage,execScripts:true})}else{this._beforeShowDialog()}},onTemplateLoaded:function o(G){var K=this;this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=G.serverResponse.responseText;var I=b.getFirstChild(this.containerDiv);this.widgets.dialog=Alfresco.util.createYUIPanel(I,{width:this.options.width});this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",this.onOK,{additionalClass:"alf-primary-button"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);var M=new YAHOO.widget.ButtonGroup(this.id+"-modeGroup");M.on("checkedButtonChange",this.onViewModeChange,this.widgets.modeButtons,this);this.widgets.modeButtons=M;var J=this.widgets.modeButtons.getButtons(),L=function(N){if(s.KEY.ENTER==N.keyCode){this.set("checked",true)}};for(var H=0;H<J.length;H++){J[H].addListener("keydown",L)}this.fnLoadNodeData=function F(R,O){var P=R.data.path;var Q=K._buildTreeNodeUrl.call(K,P);var T={success:function N(X){var W=Alfresco.util.parseJSON(X.responseText);if(W.parent){if(R.data.nodeRef.indexOf("alfresco://")===0){R.data.nodeRef=W.parent.nodeRef}if(typeof R.data.userAccess=="undefined"){R.data.userAccess=W.parent.userAccess;R.setUpLabel({label:R.label,style:W.parent.userAccess.create?"":"no-permission"});if(W.parent.userAccess.create==false){R.parent.refresh();if(this.selectedNode==R){this.widgets.okButton.set("disabled",true)}}}}if(W.items){var Y,aa;for(var V=0,U=W.items.length;V<U;V++){Y=W.items[V];var Z=this.options.mode=="sync"&&Alfresco.util.arrayContains(Y.aspects,"sync:syncSetMemberNode");aa=new YAHOO.widget.TextNode({label:Y.name,path:r(P,Y.name),nodeRef:Y.nodeRef,description:Y.description,userAccess:Z?false:Y.userAccess,style:Z?"no-permission":(Y.userAccess.create?"":"no-permission")},R,false);var ab=this._buildCustomStyleClass(Y);aa.customCls=ab;if(!Y.hasChildren){aa.isLeaf=true}}if(W.resultsTrimmed){aa=new YAHOO.widget.TextNode({label:"<"+this.msg("message.folders-trimmed",W.items.length)+">",hasIcon:false,style:"folders-trimmed"},R,false)}}X.argument.fnLoadComplete()},failure:function S(X){try{var W=YAHOO.lang.JSON.parse(X.responseText);var V=this.widgets.treeview.getRoot();var U=V.children[0];U.isLoading=false;U.isLeaf=true;U.label=W.message;U.labelStyle="ygtverror";V.refresh()}catch(Y){}},scope:K,argument:{node:R,fnLoadComplete:O},timeout:K.options.webscriptTimeout};if(YAHOO.env.ua.ie>0){Q+=(Q.indexOf("?")==-1?"?":"&")+"noCache="+new Date().getTime()}YAHOO.util.Connect.asyncRequest("GET",Q,T)};this._beforeShowDialog()},_beforeShowDialog:function t(){if(this.options.pathNodeRef){var F=Alfresco.constants.PROXY_URI+"slingshot/doclib/node/"+this.options.pathNodeRef.uri+"/location";if(this.options.rootNode){F+="?libraryRoot="+encodeURIComponent(this.options.rootNode.toString())}Alfresco.util.Ajax.jsonGet({url:F,successCallback:{fn:function(H){if(H.json!==undefined){var G=H.json;if(G.site){this.options.viewMode=z.prototype.options.defaultView;this.options.path=r(G.site.path,G.site.file);this.options.siteId=G.site.site;this.options.siteTitle=G.site.siteTitle}else{this.options.viewMode=z.VIEW_MODE_REPOSITORY;this.options.path=r(G.repo.path,G.repo.file);this.options.siteId=null;this.options.siteTitle=null}this._showDialog()}},scope:this},failureMessage:this.msg("message.failure")})}else{this._showDialog()}},_showDialog:function q(){this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);var F=b.get(this.id+"-title");if(this.options.title){F.innerHTML=this.options.title}else{if(YAHOO.lang.isArray(this.options.files)){F.innerHTML=this.msg("title.multi",this.options.files.length)}else{F.innerHTML=this.msg("title.single",'<span class="light">'+u(this.options.files.displayName)+"</span>")}}var N=Alfresco.util.arrayToObject(this.options.allowedViewModes);for(var I=0;I<Alfresco.constants.HIDDEN_PICKER_VIEW_MODES.length;I++){delete N[z[Alfresco.constants.HIDDEN_PICKER_VIEW_MODES[I]]]}var K=this.widgets.modeButtons.getButtons(),G,H;if(!(this.options.viewMode in N)){this.options.viewMode=this.options.allowedViewModes[0]}for(var I=0,O=K.length;I<O;I++){G=K[I];H=parseInt(G.get("name"),10);G.set("disabled",!(H in N));G.setStyle("display",H in N?"block":"none");if(H==this.options.viewMode){if(G.get("checked")){this.setViewMode(H)}else{G.set("checked",true)}}}if(!this.widgets.escapeListener){this.widgets.escapeListener=new s(document,{keys:s.KEY.ESCAPE},{fn:function(Q,P){this.onCancel()},scope:this,correctScope:true})}this.widgets.dialog.render(this.options.parentElement||document.body);if(this.options.zIndex!==undefined&&this.options.zIndex>0){var L=this.options.zIndex+2;var M=this.widgets.dialog;var J=function(){elements=b.getElementsByClassName("mask");for(I=0,j=elements.length;I<j;I++){b.setStyle(elements[I],"zIndex",L-1)}b.setStyle(M.element,"zIndex",L);M.cfg.setProperty("zIndex",L,true)};this.widgets.dialog.beforeShowEvent.subscribe(J,this.widgets.dialog,true)}this.widgets.escapeListener.enable();this.widgets.dialog.show()},setViewMode:function k(F){this.options.viewMode=F;if(this._isSiteViewMode(F)){b.get(this.id+"-treeview").innerHTML="";b.removeClass(this.id+"-wrapper","repository-mode");this._populateSitePicker(F)}else{b.addClass(this.id+"-wrapper","repository-mode");var G=this.options.rootNode;if(F==z.VIEW_MODE_USERHOME){G=this.options.userHome}else{if(F==z.VIEW_MODE_SHARED){G=this.options.sharedRoot}}this._buildTree(G);this.onPathChanged(this.options.path?this.options.path:"/")}},onSiteChanged:function A(K,I){if(B(this,I)){var M=I[1];if(M!==null){if(M.site!==null){this.options.siteId=M.site;this.options.siteTitle=M.siteTitle;this._populateContainerPicker();var L=x.query("a",this.id+"-sitePicker"),H,J,G,F=b.get(this.id+"-sitePicker");for(J=0,G=L.length;J<G;J++){H=L[J];if(H.getAttribute("rel")==M.site){b.addClass(H,"selected");if(M.scrollTo){F.scrollTop=b.getY(H)-b.getY(F)}}else{b.removeClass(H,"selected")}}}}}},onContainerChanged:function f(K,I){if(B(this,I)){var M=I[1];if(M!==null){if(M.container!==null){this.options.containerId=M.container;this.options.containerType=this.containers[M.container].type;this._buildTree(this.containers[M.container].nodeRef);this.onPathChanged(this.options.path);var L=x.query("a",this.id+"-containerPicker"),F,J,H,G=b.get(this.id+"-containerPicker");for(J=0,H=L.length;J<H;J++){F=L[J];if(F.getAttribute("rel")==M.container){b.addClass(F,"selected");if(M.scrollTo){G.scrollTop=b.getY(F)-b.getY(G)}}else{b.removeClass(F,"selected")}}}}}},onOK:function l(G,H){this.widgets.escapeListener.disable();this.widgets.dialog.hide();var F=this.selectedNode?this.selectedNode.data:null;if(F&&this._isSiteViewMode(this.options.viewMode)){F.siteId=this.options.siteId;F.siteTitle=this.options.siteTitle;F.containerId=this.options.containerId}YAHOO.Bubbling.fire("folderSelected",{selectedFolder:F,eventGroup:this})},onCancel:function a(F,G){this.widgets.escapeListener.disable();this.widgets.dialog.hide()},onViewModeChange:function n(H,I){var G=this.options.viewMode;try{G=parseInt(H.newValue.get("name"),10);this.setViewMode(G)}catch(F){}},onExpandComplete:function h(I){Alfresco.logger.debug("DLGF_onExpandComplete");this.widgets.treeview.render();this._showHighlight(true);if(this.pathsToExpand&&this.pathsToExpand.length>0){var H=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(H!==null){var G=H.getContentEl(),F=b.get(this.id+"-treeview");F.scrollTop=b.getY(G)-(F.scrollHeight/3);if(H.data.path==this.currentPath){this._updateSelectedNode(H)}H.expand()}}},onNodeClicked:function w(G){Alfresco.logger.debug("DLGF_onNodeClicked");var I=G.event,H=G.node,F=H.data.userAccess;if((F&&F.create)||(H.data.nodeRef=="")||(H.data.nodeRef.indexOf("alfresco://")===0)){this.onPathChanged(H.data.path);this._updateSelectedNode(H)}E.preventDefault(I);return false},onPathChanged:function d(J){this._showHighlight(false);this.selectedNode=null;Alfresco.logger.debug("DLGF_onPathChanged:"+J);if(J.charAt(0)!="/"){J="/"+J}this.currentPath=J;var I=this.widgets.treeview.getNodeByProperty("path",J);if(I!==null){this._updateSelectedNode(I);I.expand();while(I.parent!==null){I=I.parent;I.expand()}return}var K=J.split("/"),H="/";if(J==="/"){K=[""]}this.pathsToExpand=[];for(var G=0,F=K.length;G<F;G++){H=r("/",H,K[G]);this.pathsToExpand.push(H)}Alfresco.logger.debug("DLGF_onPathChanged paths to expand:"+this.pathsToExpand.join(","));do{I=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(this.selectedNode==null){this._updateSelectedNode(I)}}while(this.pathsToExpand.length>0&&I.expanded);if(I!==null){I.expand()}},_populateSitePicker:function y(I){var G=b.get(this.id+"-sitePicker"),K=this;G.innerHTML="";var J=function F(O,S){var T=O.json,Q,M,R,P,V=null;var U=function N(W){return function(){YAHOO.Bubbling.fire("siteChanged",{site:W.shortName,siteTitle:W.title,eventGroup:K});return false}};if(T.length>0){V=T[0]}for(R=0,P=T.length;R<P;R++){M=T[R];if(Alfresco.util.arrayToObject(M.shortName)){if(V==null){V=M}Q=document.createElement("div");if(R==P-1){b.addClass(Q,"last")}Q.innerHTML='<a rel="'+M.shortName+'" href="#""><h4>'+u(M.title)+"</h4><span>"+u(M.description)+"</span></a>";Q.onclick=U(M);S.appendChild(Q)}}if(V!=null){YAHOO.Bubbling.fire("siteChanged",{site:(this.options.siteId&&this.options.siteId.length>0)?this.options.siteId:V.shortName,siteTitle:(this.options.siteId&&this.options.siteId.length>0)?this.options.siteTitle:V.title,eventGroup:this,scrollTo:true})}};var L=this.options.sitesAPI;if(I===z.VIEW_MODE_RECENT_SITES){L=this.options.recentSitesAPI}else{if(I===z.VIEW_MODE_FAVOURITE_SITES){L=this.options.favouriteSitesAPI}}var H={url:L,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:J,scope:this,obj:G},failureCallback:null};Alfresco.util.Ajax.request(H)},_populateContainerPicker:function e(){var M=b.get(this.id+"-containerPicker"),J=this;M.innerHTML="";var I=function F(P,U){var O=P.json.containers,R,N,S,Q;this.containers={};var V=function T(W){return function(){YAHOO.Bubbling.fire("containerChanged",{container:W,eventGroup:J});return false}};for(S=0,Q=O.length;S<Q;S++){N=O[S];this.containers[N.name]=N;R=document.createElement("div");if(S==Q-1){b.addClass(R,"last")}R.innerHTML='<a rel="'+N.name+'" href="#"><h4>'+N.name+"</h4><span>"+N.description+"</span></a>";R.onclick=V(N.name);U.appendChild(R)}YAHOO.Bubbling.fire("containerChanged",{container:this.options.containerId,eventGroup:this,scrollTo:true})};var L=function K(P){try{var O=this.widgets.treeview.getRoot(),N=O.children[0];N.isLoading=false;N.isLeaf=true;N.label=this.msg("message.error");N.labelStyle="ygtverror";O.refresh()}catch(Q){}M.innerHTML=""};var H=Alfresco.util.parseURL(this.options.containersAPI);H.pathname+=this.options.siteId;var G={url:H.getUrl(),responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:I,scope:this,obj:M},failureCallback:{fn:L,scope:this}};Alfresco.util.Ajax.request(G)},_buildTree:function g(I){Alfresco.logger.debug("DLGF__buildTree");var F=new YAHOO.widget.TreeView(this.id+"-treeview");this.widgets.treeview=F;YAHOO.widget.TreeView.FOCUS_CLASS_NAME="";F.setDynamicLoad(this.fnLoadNodeData);var G="location.path.repository";if(this._isSiteViewMode(this.options.viewMode)){var H=this.options.siteTreeContainerTypes[this.options.containerType]||{};G=H.rootLabel||"location.path.documents"}else{if(this.options.viewMode==z.VIEW_MODE_USERHOME){G="location.path.myfiles"}else{if(this.options.viewMode==z.VIEW_MODE_SHARED){G="location.path.shared"}}}var J=new YAHOO.widget.TextNode({label:this.msg(G),path:"/",nodeRef:I},F.getRoot(),false);F.subscribe("clickEvent",this.onNodeClicked,this,true);F.subscribe("expandComplete",this.onExpandComplete,this,true);F.render()},_showHighlight:function p(F){Alfresco.logger.debug("DLGF__showHighlight");if(this.selectedNode!==null){if(F){b.addClass(this.selectedNode.getEl(),"selected")}else{b.removeClass(this.selectedNode.getEl(),"selected")}}},_updateSelectedNode:function v(F){Alfresco.logger.debug("DLGF__updateSelectedNode");this._showHighlight(false);this.selectedNode=F;this._showHighlight(true);if(F.data.userAccess&&!F.data.userAccess.create){this.widgets.okButton.set("disabled",true)}else{this.widgets.okButton.set("disabled",false)}},_buildTreeNodeUrl:function c(H){var I=Alfresco.constants.PROXY_URI;if(this._isSiteViewMode(this.options.viewMode)){var F=this.options.siteTreeContainerTypes[this.options.containerType]||{};if(F.uri){I+=F.uri}else{I+="slingshot/doclib/treenode/site/{site}/{container}{path}";I+="?children={evaluateChildFoldersSite}";I+="&max={maximumFolderCountSite}"}}else{if(this.options.viewMode==z.VIEW_MODE_USERHOME){I+="slingshot/doclib/treenode/node/{userHome}{path}";I+="?children={evaluateChildFoldersRepo}"}else{if(this.options.viewMode==z.VIEW_MODE_SHARED){I+="slingshot/doclib/treenode/node/{sharedRootPath}{path}";I+="?children={evaluateChildFoldersRepo}";I+="&libraryRoot={sharedRoot}"}else{I+="slingshot/doclib/treenode/node/alfresco/company/home{path}";I+="?children={evaluateChildFoldersRepo}";I+="&libraryRoot={rootNode}"}}I+="&max={maximumFolderCountRepo}"}var G=YAHOO.lang.substitute(I,{site:encodeURIComponent(this.options.siteId),container:encodeURIComponent(this.options.containerId),rootNode:this.options.rootNode,userHome:(this.options.userHome||"").replace(":/",""),sharedRoot:this.options.sharedRoot,sharedRootPath:this.options.sharedRoot.replace(":/",""),path:Alfresco.util.encodeURIPath(H),evaluateChildFoldersSite:this.options.evaluateChildFoldersSite+"",maximumFolderCountSite:this.options.maximumFolderCountSite,evaluateChildFoldersRepo:this.options.evaluateChildFoldersRepo+"",maximumFolderCountRepo:this.options.maximumFolderCountRepo});return G},_buildCustomStyleClass:function i(F){var H=null;if(this.options.customFolderStyleConfig){var G=new Alfresco.CommonComponentStyleFilterChain(F,this.options.customFolderStyleConfig.browse.folder);H=G.createCustomStyle()}return H},_isSiteViewMode:function D(G){var F=[z.VIEW_MODE_SITE,z.VIEW_MODE_FAVOURITE_SITES,z.VIEW_MODE_RECENT_SITES];return(Alfresco.util.arrayContains(F,G))}});var C=new Alfresco.module.DoclibGlobalFolder("null")})();