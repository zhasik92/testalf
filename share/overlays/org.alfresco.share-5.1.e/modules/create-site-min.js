(function(){var f=YAHOO.util.Dom,m=YAHOO.util.Event,b=YAHOO.util.Element,a=YAHOO.util.KeyListener;Alfresco.module.CreateSite=function(p){var o=Alfresco.util.ComponentManager.get(this.id);if(o!==null){throw new Error("An instance of Alfresco.module.CreateSite already exists.")}Alfresco.module.CreateSite.superclass.constructor.call(this,"Alfresco.module.CreateSite",p,["button","container","connection","selector","json"]);return this};YAHOO.extend(Alfresco.module.CreateSite,Alfresco.component.Base,{show:function e(){if(this.widgets.panel){this._showPanel()}else{Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/create-site",dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},execScripts:true,failureMessage:"Could not load create site template"})}},onTemplateLoaded:function i(q){var u=document.createElement("div");u.innerHTML=q.serverResponse.responseText;var s=f.getFirstChild(u);this.widgets.panel=Alfresco.util.createYUIPanel(s);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok-button",null,{type:"submit",additionalClass:"alf-primary-button"});this.widgets.siteVisibility=f.get(this.id+"-visibility");this.widgets.isPublic=f.get(this.id+"-isPublic");this.widgets.isModerated=f.get(this.id+"-isModerated");this.widgets.isPrivate=f.get(this.id+"-isPrivate");var o=new Alfresco.forms.Form(this.id+"-form");this.widgets.form=o;this.elTitle=f.get(this.id+"-title");this.elShortName=f.get(this.id+"-shortName");o.addValidation(this.elTitle,Alfresco.forms.validation.mandatory,null,"keyup",this.msg("validation-hint.mandatory"));o.addValidation(this.elTitle,Alfresco.forms.validation.length,{max:256,crop:true},"keyup");m.addListener(this.elTitle,"keyup",this.onSiteNameChange,this,true);m.addListener(this.elTitle,"mouseout",this.onSiteNameChange,this,true);this.shortNameEdited=false;o.addValidation(this.elShortName,Alfresco.forms.validation.mandatory,null,"keyup",this.msg("validation-hint.mandatory"));o.addValidation(this.elShortName,Alfresco.forms.validation.regexMatch,{pattern:/^[ ]*[0-9a-zA-Z\-]+[ ]*$/},"keyup",this.msg("validation-hint.siteName"));o.addValidation(this.elShortName,Alfresco.forms.validation.length,{max:72,crop:true},"keyup");m.addListener(this.elShortName,"keyup",function t(){this.shortNameEdited=this.elShortName.value.length>0},this,true);o.addValidation(this.id+"-description",Alfresco.forms.validation.length,{max:512,crop:true},"keyup");var r=f.get(this.id+"-sitePreset");m.addListener(r,"change",function p(){this.onSitePresetChange(r.options[r.selectedIndex].value)},this,true);if(r.options.length>0){this.onSitePresetChange(r.options[r.selectedIndex].value)}o.setSubmitElements(this.widgets.okButton);o.doBeforeFormSubmit={fn:this.doBeforeFormSubmit,obj:null,scope:this};o.setAJAXSubmit(true,{successCallback:{fn:this.onCreateSiteSuccess,scope:this},failureCallback:{fn:this.onCreateSiteFailure,scope:this}});o.setSubmitAsJSON(true);o.applyTabFix();o.doBeforeAjaxRequest={fn:this.doBeforeAjaxRequest,scope:this};o.init();this._showPanel()},onSitePresetChange:function(o){},doBeforeAjaxRequest:function g(o){return true},doBeforeFormSubmit:function(q,r){var p=f.get(this.id+"-form");p.attributes.action.nodeValue=Alfresco.constants.URL_SERVICECONTEXT+"modules/create-site";this.widgets.cancelButton.set("disabled",true);var o;if(this.widgets.isPublic.checked){o="PUBLIC"}else{if(this.widgets.isModerated.checked){o="MODERATED"}else{o="PRIVATE"}}this.widgets.siteVisibility.value=o;this.widgets.panel.hide();this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.creating",this.name),spanClass:"wait",displayTime:0})},safeURL:function k(o){o=YAHOO.lang.trim(o.replace(/[^0-9a-zA-Z\-\s]/g,""));o=o.replace(/\s+/g,"-").toLowerCase();return o},onSiteNameChange:function l(p,o){if(!this.shortNameEdited){this.elShortName.value=this.safeURL(this.elTitle.value).substring(0,72);this.widgets.form.validate()}},onCancelButtonClick:function c(p,o){try{f.get(this.id+"-title").value="";f.get(this.id+"-shortName").value="";f.get(this.id+"-description").value="";f.get(this.id+"-sitePreset").selectedIndex=0;f.get(this.id+"-isPublic").checked="checked";f.get(this.id+"-isModerated").checked="";f.get(this.id+"-isModerated").disabled=false}catch(q){}this.widgets.panel.hide()},onCreateSiteSuccess:function d(p){if(p.json!==undefined&&p.json.success){var q=new Alfresco.service.Preferences(),o=p.config.dataObj.shortName;q.favouriteSite(o,{successCallback:{fn:function r(){document.location.href=Alfresco.constants.URL_PAGECONTEXT+"site/"+o+"/dashboard"}}})}else{this._adjustGUIAfterFailure(p)}},onCreateSiteFailure:function h(o){this._adjustGUIAfterFailure(o)},_adjustGUIAfterFailure:function n(o){this.widgets.feedbackMessage.destroy();this.widgets.cancelButton.set("disabled",false);this.widgets.panel.show();var q=Alfresco.util.message("message.failure",this.name);if(o.serverResponse.status===403){if(o.json.message){q=Alfresco.util.message(o.json.message,this.name)}else{q=Alfresco.util.message("error.noPermissions",this.name)}}else{if(o.json.message){var p=Alfresco.util.message(o.json.message,this.name);q=p?p:q}}Alfresco.util.PopupManager.displayPrompt({title:Alfresco.util.message("message.failure",this.name),text:q})},_showPanel:function j(){this.widgets.form.reset();this.widgets.panel.show();Alfresco.util.caretFix(this.id+"-form");if(!this.widgets.escapeListener){this.widgets.escapeListener=new a(document,{keys:a.KEY.ESCAPE},{fn:function(p,o){this.onCancelButtonClick()},scope:this,correctScope:true});this.widgets.escapeListener.enable()}f.get(this.id+"-title").focus()}})})();Alfresco.module.getCreateSiteInstance=function(){var a="alfresco-createSite-instance";return Alfresco.util.ComponentManager.get(a)||new Alfresco.module.CreateSite(a)};